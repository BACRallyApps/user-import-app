<!DOCTYPE html>
<html>
<head>
    <title>user-import-app</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:{},margin:25,launch:function(){app=this;var ff=Ext.create("Ext.form.field.File",{margin:10,id:"form-file",emptyText:"Select an image",fieldLabel:"Upload File",name:"photo-path",buttonText:"Select",listeners:{afterrender:function(){var f=document.querySelector('input[type="file"]');app.addFileEvent(f)}},width:400,autoRender:!0});app.add(ff)},addFileEvent:function(f){f.addEventListener("change",function(){file=event.target.files[0],console.log("file",file);var reader=new FileReader;reader.onload=function(event){var csvArray=app.csvToObject(app.csvToArray(event.target.result));app.addGrid(csvArray)},reader.onerror=function(){console.log("On Error Event")},reader.readAsText(file)})},csvToArray:function(csvString){var csvArray=[],csvRows=csvString.split(/[\r\n]/);console.log("rows",csvRows.length);for(var rowIndex=0;csvRows.length>rowIndex;rowIndex++){var rowArray=app.CSVRowtoArray(csvRows[rowIndex]);0===rowIndex&&console.log(rowArray),null!==rowArray&&csvArray.push(rowArray)}return csvArray},CSVRowtoArray:function(text){var re_valid=/^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/,re_value=/(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;if(!re_valid.test(text))return console.warn("CSVtoArray: Invalid csv text.\n\nSee http://stackoverflow.com/questions/8493195/how-can-i-parse-a-csv-string-with-javascript for help."),console.warn(text),null;var a=[];return text.replace(re_value,function(m0,m1,m2,m3){return void 0!==m1?a.push(m1.replace(/\\'/g,"'")):void 0!==m2?a.push(m2.replace(/\\"/g,'"')):void 0!==m3&&a.push(m3),""}),/,\s*$/.test(text)&&a.push(""),a},csvToObject:function(csvArray){var header=[],csv=[];return _.each(csvArray,function(row,i){if(0===i)header=row,header=_.map(header,function(h){return h.replace(/\./g,"-")});else{var r={};_.each(header,function(cHeader,cIndex){r[cHeader]=row[cIndex]}),csv.push(r)}}),csv},addGrid:function(csvData){var colHeaders=_.keys(csvData[0]);console.log("Col Headers",colHeaders),Ext.create("Ext.data.Store",{storeId:"csvStore",fields:colHeaders,data:{items:csvData},proxy:{type:"memory",reader:{type:"json",root:"items"}}});var columns=_.map(_.keys(csvData[0]),function(k){return{text:k,dataIndex:k,flex:1,width:100}});console.log("cols:",columns),void 0!==app.grid&&null!==app.grid&&app.grid.destroy(),app.grid=Ext.create("Ext.grid.Panel",{title:"csv",store:Ext.data.StoreManager.lookup("csvStore"),columns:columns}),app.add(app.grid)}});

            Rally.launchApp('CustomApp', {
                name:"user-import-app",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
